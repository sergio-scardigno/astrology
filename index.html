<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Carta Astral</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Arial', sans-serif;
                background: linear-gradient(135deg, #1e3c72, #2a5298);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                overflow-x: auto;
            }

            .header {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .form-section {
                padding: 30px;
                background: #f8f9fa;
            }

            .form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group label {
                font-weight: bold;
                margin-bottom: 5px;
                color: #333;
            }

            .form-group input,
            .form-group select {
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #667eea;
            }

            .city-search-container {
                grid-column: span 2;
                position: relative;
            }

            .city-search-input {
                width: 100%;
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
            }

            .city-search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 2px solid #ddd;
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }

            .city-result {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                transition: background-color 0.2s;
            }

            .city-result:hover {
                background-color: #f8f9fa;
            }

            .city-result:last-child {
                border-bottom: none;
            }

            .city-name {
                font-weight: bold;
                color: #333;
            }

            .city-details {
                font-size: 12px;
                color: #666;
                margin-top: 2px;
            }

            .selected-city {
                background: #e3f2fd;
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                border-left: 4px solid #667eea;
            }

            .selected-city-info {
                font-weight: bold;
                color: #333;
            }

            .selected-city-coords {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }

            .btn {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                padding: 15px 30px;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .btn:hover {
                transform: translateY(-2px);
            }

            .chart-container {
                padding: 30px;
                text-align: center;
            }

            .chart {
                position: relative;
                width: 600px;
                height: 600px;
                margin: 0 auto;
                border: 3px solid #333;
                border-radius: 50%;
                background: #f8f9fa;
            }

            .sign {
                position: absolute;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: 12px;
                text-align: center;
            }

            .planet {
                position: absolute;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: 10px;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .planet:hover {
                transform: scale(1.2);
            }

            .house {
                position: absolute;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: #333;
                font-size: 8px;
                background: #fff;
                border: 2px solid #333;
            }

            .fire {
                background: #ff4757;
            }
            .earth {
                background: #2ed573;
            }
            .air {
                background: #3742fa;
            }
            .water {
                background: #5352ed;
            }

            .results {
                padding: 30px;
                background: white;
            }

            .planet-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .planet-card {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                border-left: 5px solid #667eea;
            }

            .planet-card h3 {
                color: #333;
                margin-bottom: 10px;
            }

            .aspects {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .balance-section {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .balance-summary {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 5px solid #667eea;
            }

            .element-bar {
                display: flex;
                align-items: center;
                margin: 10px 0;
                gap: 10px;
            }

            .element-name {
                width: 80px;
                font-weight: bold;
            }

            .element-progress {
                flex: 1;
                background: #e9ecef;
                border-radius: 10px;
                height: 20px;
                overflow: hidden;
            }

            .element-fill {
                height: 100%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 12px;
            }

            .element-fill.fire {
                background: #ff4757;
            }
            .element-fill.earth {
                background: #2ed573;
            }
            .element-fill.air {
                background: #3742fa;
            }
            .element-fill.water {
                background: #5352ed;
            }

            .element-stats {
                width: 100px;
                text-align: right;
                font-weight: bold;
            }

            .loading {
                text-align: center;
                padding: 50px;
                font-size: 18px;
                color: #666;
            }

            .error {
                background: #ff4757;
                color: white;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
            }

            .location-info {
                background: #e8f5e8;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
                border-left: 4px solid #2ed573;
            }

            .positions-section {
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .astro-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            .astro-table th,
            .astro-table td {
                border: 1px solid #bbb;
                padding: 6px 10px;
                text-align: center;
            }
            .astro-table th {
                background: #f3f3f3;
                font-weight: bold;
            }
            .astro-table tbody tr:nth-child(even) {
                background: #fafafa;
            }

            /* Estilos para Responsive Design */
            @media (max-width: 768px) {
                body {
                    padding: 10px;
                }

                .header {
                    padding: 20px;
                }

                .header h1 {
                    font-size: 2em;
                }

                .form-grid {
                    grid-template-columns: 1fr;
                }

                .city-search-container {
                    grid-column: span 1;
                }

                .form-section,
                .results {
                    padding: 20px;
                }

                .chart-container {
                    padding: 10px 0;
                }

                #chartCanvas {
                    width: 100%;
                    height: auto;
                }

                .planet-info {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 480px) {
                .header h1 {
                    font-size: 1.8em;
                }

                .form-section,
                .results {
                    padding: 15px;
                }

                .btn {
                    padding: 12px 20px;
                    font-size: 16px;
                }
            }
        </style>
    </head>
    <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <div class="container">
            <div class="header">
                <h1>üåü Carta Astral üåü</h1>
                <p>Descubre tu mapa astrol√≥gico personal</p>
            </div>

            <div class="form-section">
                <form id="birthForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="anio">A√±o de nacimiento:</label>
                            <input
                                type="number"
                                id="anio"
                                name="anio"
                                min="1900"
                                max="2100"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="mes">Mes:</label>
                            <select id="mes" name="mes" required>
                                <option value="">Seleccionar mes</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dia">D√≠a:</label>
                            <input
                                type="number"
                                id="dia"
                                name="dia"
                                min="1"
                                max="31"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="hora">Hora:</label>
                            <div style="display: flex; gap: 10px">
                                <select
                                    id="hora"
                                    name="hora"
                                    required
                                    style="width: 100%"
                                >
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12" selected>12</option>
                                </select>
                                <select
                                    id="ampm"
                                    name="ampm"
                                    required
                                    style="width: 100%"
                                >
                                    <option value="am">AM</option>
                                    <option value="pm">PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="minuto">Minuto:</label>
                            <input
                                type="number"
                                id="minuto"
                                name="minuto"
                                min="0"
                                max="59"
                                value="0"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="tz">Zona horaria:</label>
                            <input
                                type="text"
                                id="tz"
                                name="tz"
                                value=""
                                readonly
                                style="
                                    background: #f3f3f3;
                                    color: #333;
                                    font-weight: bold;
                                    cursor: not-allowed;
                                "
                            />
                        </div>
                        <div class="form-group city-search-container">
                            <label for="citySearch"
                                >Ciudad de nacimiento (o ingrese
                                coordenadas):</label
                            >
                            <input
                                type="text"
                                id="citySearch"
                                placeholder="Busca tu ciudad (ej: Madrid, Buenos Aires)"
                                class="city-search-input"
                            />
                            <div
                                id="citySearchResults"
                                class="city-search-results"
                            ></div>
                            <div
                                id="selectedCity"
                                class="selected-city"
                                style="display: none"
                            >
                                <div
                                    class="selected-city-info"
                                    id="selectedCityInfo"
                                ></div>
                                <div
                                    class="selected-city-coords"
                                    id="selectedCityCoords"
                                ></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="lat">Latitud:</label>
                            <input
                                type="text"
                                id="lat"
                                name="lat"
                                placeholder="Ej: 40.4168"
                            />
                        </div>
                        <div class="form-group">
                            <label for="lon">Longitud:</label>
                            <input
                                type="text"
                                id="lon"
                                name="lon"
                                placeholder="Ej: -3.7038"
                            />
                        </div>
                    </div>
                    <button type="submit" class="btn">
                        Generar Carta Astral
                    </button>
                </form>
            </div>

            <div id="loading" class="loading" style="display: none">
                <p>üîÑ Calculando tu carta astral...</p>
            </div>

            <div id="error" class="error" style="display: none"></div>

            <div id="results" class="results" style="display: none">
                <button
                    id="downloadPdfBtn"
                    class="btn"
                    style="margin-bottom: 20px"
                >
                    Descargar como PDF
                </button>
                <div
                    id="locationInfo"
                    class="location-info"
                    style="display: none"
                >
                    <strong>üìç Ubicaci√≥n:</strong>
                    <span id="locationText"></span>
                </div>

                <div class="chart-container">
                    <canvas id="chartCanvas" width="600" height="600"></canvas>
                </div>

                <div class="positions-section">
                    <h2>Posiciones Planetarias</h2>
                    <div id="planetPositions"></div>
                    <h2>C√∫spides de Casas</h2>
                    <div id="houseCusps"></div>
                    <h2>Aspectos</h2>
                    <div id="aspectsTable"></div>
                </div>

                <div class="planet-info" id="planetInfo"></div>

                <div class="aspects">
                    <h2>Aspectos Planetarios</h2>
                    <div id="aspectsList"></div>
                </div>

                <div class="balance-section">
                    <h2>Balance de Elementos</h2>
                    <div id="balanceElementos"></div>
                </div>
            </div>
        </div>

        <script>
            const SIGNS = [
                'Aries',
                'Tauro',
                'G√©minis',
                'C√°ncer',
                'Leo',
                'Virgo',
                'Libra',
                'Escorpio',
                'Sagitario',
                'Capricornio',
                'Acuario',
                'Piscis',
            ];

            const ELEMENTOS = {
                Aries: 'fire',
                Leo: 'fire',
                Sagitario: 'fire',
                Tauro: 'earth',
                Virgo: 'earth',
                Capricornio: 'earth',
                G√©minis: 'air',
                Libra: 'air',
                Acuario: 'air',
                C√°ncer: 'water',
                Escorpio: 'water',
                Piscis: 'water',
            };

            const PLANET_SYMBOLS = {
                sol: '‚òâ',
                luna: '‚òΩ',
                mercurio: '‚òø',
                venus: '‚ôÄ',
                marte: '‚ôÇ',
                jupiter: '‚ôÉ',
                saturno: '‚ôÑ',
                urano: '‚ôÖ',
                neptuno: '‚ôÜ',
                pluton: '‚ôá',
            };

            const PLANET_NAMES = {
                sol: 'Sol',
                luna: 'Luna',
                mercurio: 'Mercurio',
                venus: 'Venus',
                marte: 'Marte',
                jupiter: 'J√∫piter',
                saturno: 'Saturno',
                urano: 'Urano',
                neptuno: 'Neptuno',
                pluton: 'Plut√≥n',
            };

            const SIGN_SYMBOLS = {
                Aries: '‚ôà',
                Tauro: '‚ôâ',
                G√©minis: '‚ôä',
                C√°ncer: '‚ôã',
                Leo: '‚ôå',
                Virgo: '‚ôç',
                Libra: '‚ôé',
                Escorpio: '‚ôè',
                Sagitario: '‚ôê',
                Capricornio: '‚ôë',
                Acuario: '‚ôí',
                Piscis: '‚ôì',
            };

            let selectedCity = null;
            let searchTimeout = null;

            // B√∫squeda de ciudades
            document
                .getElementById('citySearch')
                .addEventListener('input', function (e) {
                    const query = e.target.value.trim();

                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }

                    if (query.length < 2) {
                        hideCityResults();
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        searchCities(query);
                    }, 300);
                });

            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.city-search-container')) {
                    hideCityResults();
                }
            });

            async function searchCities(query) {
                try {
                    const response = await fetch(
                        `/buscar_ciudades?q=${encodeURIComponent(query)}`
                    );
                    const data = await response.json();

                    if (response.ok) {
                        displayCityResults(data.results);
                    } else {
                        console.error('Error buscando ciudades:', data);
                    }
                } catch (error) {
                    console.error('Error de conexi√≥n:', error);
                }
            }

            function displayCityResults(cities) {
                const resultsContainer =
                    document.getElementById('citySearchResults');
                resultsContainer.innerHTML = '';

                if (cities.length === 0) {
                    resultsContainer.innerHTML =
                        '<div class="city-result">No se encontraron ciudades</div>';
                } else {
                    cities.forEach((city) => {
                        const cityElement = document.createElement('div');
                        cityElement.className = 'city-result';
                        cityElement.innerHTML = `
                            <div class="city-name">${
                                city.city || city.name
                            }</div>
                            <div class="city-details">${
                                city.state ? city.state + ', ' : ''
                            }${city.country}</div>
                        `;
                        cityElement.addEventListener('click', () =>
                            selectCity(city)
                        );
                        resultsContainer.appendChild(cityElement);
                    });
                }

                resultsContainer.style.display = 'block';
            }

            function selectCity(city) {
                selectedCity = city;

                const selectedCityDiv = document.getElementById('selectedCity');
                const selectedCityInfo =
                    document.getElementById('selectedCityInfo');
                const selectedCityCoords =
                    document.getElementById('selectedCityCoords');

                selectedCityInfo.textContent = `${city.city || city.name}, ${
                    city.state ? city.state + ', ' : ''
                }${city.country}`;
                selectedCityCoords.textContent = `Lat: ${city.lat.toFixed(
                    4
                )}, Lon: ${city.lon.toFixed(4)}`;

                // Rellenar campos de lat y lon
                document.getElementById('lat').value = city.lat.toFixed(4);
                document.getElementById('lon').value = city.lon.toFixed(4);

                selectedCityDiv.style.display = 'block';
                hideCityResults();

                // Limpiar el campo de b√∫squeda
                document.getElementById('citySearch').value =
                    city.city || city.name;
            }

            function hideCityResults() {
                document.getElementById('citySearchResults').style.display =
                    'none';
            }

            document
                .getElementById('birthForm')
                .addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const params = new URLSearchParams();

                    let hora = parseInt(formData.get('hora'), 10);
                    const ampm = formData.get('ampm');

                    if (ampm === 'pm' && hora < 12) {
                        hora += 12;
                    }
                    if (ampm === 'am' && hora === 12) {
                        // Medianoche
                        hora = 0;
                    }

                    params.append('anio', formData.get('anio'));
                    params.append('mes', formData.get('mes'));
                    params.append('dia', formData.get('dia'));
                    params.append('hora', hora);
                    params.append('minuto', formData.get('minuto'));

                    // Agregar ciudad si est√° seleccionada
                    if (selectedCity) {
                        params.append(
                            'ciudad',
                            selectedCity.city || selectedCity.name
                        );
                        if (selectedCity.country) {
                            params.append('pais', selectedCity.country);
                        }
                    } else {
                        // O usar lat/lon si se ingresaron manualmente
                        const lat = document.getElementById('lat').value;
                        const lon = document.getElementById('lon').value;
                        if (lat && lon) {
                            params.append('lat', lat);
                            params.append('lon', lon);
                        }
                    }

                    showLoading();

                    try {
                        const response = await fetch(`/carta?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            displayChart(data);
                        } else {
                            showError(
                                'Error al generar la carta astral: ' +
                                    (data.error ||
                                        data.detail ||
                                        'Error desconocido')
                            );
                        }
                    } catch (error) {
                        showError('Error de conexi√≥n: ' + error.message);
                    }
                });

            function showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';
                document.getElementById('error').style.display = 'none';
            }

            function showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = message;
            }

            function displayChart(data) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                if (!data) {
                    showError('No se recibieron datos de la API');
                    return;
                }

                // Mostrar informaci√≥n de ubicaci√≥n si est√° disponible
                if (data.ubicacion) {
                    const locationInfo =
                        document.getElementById('locationInfo');
                    const locationText =
                        document.getElementById('locationText');

                    if (data.ubicacion.ciudad) {
                        locationText.textContent = `${data.ubicacion.ciudad}, ${data.ubicacion.pais}`;
                        locationInfo.style.display = 'block';
                    } else {
                        locationInfo.style.display = 'none';
                    }
                }

                // Mostrar zona horaria si est√° disponible
                if (typeof data.zona_horaria !== 'undefined') {
                    document.getElementById('tz').value =
                        data.zona_horaria + ' (UTC)';
                }

                drawChart(data);
                displayPlanetInfo(data);
                displayPlanetPositions(data);
                displayHouseCusps(data);
                displayAspectsTable(data);
                displayAspects(data.aspects || []);
                displayBalanceElementos(data.balance_elementos);
            }

            document
                .getElementById('downloadPdfBtn')
                .addEventListener('click', () => {
                    const { jsPDF } = window.jspdf;
                    const resultsElement = document.getElementById('results');

                    // Ocultar el bot√≥n de descarga para que no aparezca en el PDF
                    const downloadBtn =
                        document.getElementById('downloadPdfBtn');
                    downloadBtn.style.display = 'none';

                    html2canvas(resultsElement, {
                        scale: 2, // Aumentar la escala para mejor calidad de imagen
                        useCORS: true,
                    })
                        .then((canvas) => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jsPDF({
                                orientation: 'p',
                                unit: 'px',
                                format: [canvas.width, canvas.height],
                            });
                            pdf.addImage(
                                imgData,
                                'PNG',
                                0,
                                0,
                                canvas.width,
                                canvas.height
                            );
                            pdf.save('carta-astral.pdf');

                            // Volver a mostrar el bot√≥n de descarga
                            downloadBtn.style.display = 'block';
                        })
                        .catch((err) => {
                            console.error('Error al generar el PDF:', err);
                            // Asegurarse de que el bot√≥n vuelva a aparecer si hay un error
                            downloadBtn.style.display = 'block';
                        });
                });

            function drawChart(data) {
                const canvas = document.getElementById('chartCanvas');
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = 250;
                const innerRadius = 170; // Radio para el c√≠rculo de casas
                const signRadius = radius - 10; // Radio para los signos
                const houseLabelRadius = innerRadius - 25; // Radio para etiquetas de casas
                const planetRadius = innerRadius - 60; // Radio para planetas

                // Limpiar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Doble c√≠rculo: exterior (signos) e interior (casas)
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, innerRadius, 0, 2 * Math.PI);
                ctx.stroke();

                // Dibujar signos del zodiaco (l√≠neas y s√≠mbolos grandes)
                for (let i = 0; i < 12; i++) {
                    const angle = ((i * 30 - 90) * Math.PI) / 180;
                    // L√≠nea divisoria de signos
                    ctx.strokeStyle = '#bdbdbd';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(
                        centerX + innerRadius * Math.cos(angle),
                        centerY + innerRadius * Math.sin(angle)
                    );
                    ctx.lineTo(
                        centerX + radius * Math.cos(angle),
                        centerY + radius * Math.sin(angle)
                    );
                    ctx.stroke();
                    // S√≠mbolo grande del signo
                    const sign = SIGNS[i];
                    const signSymbol = SIGN_SYMBOLS[sign] || '';
                    const x = centerX + signRadius * Math.cos(angle);
                    const y = centerY + signRadius * Math.sin(angle);
                    ctx.fillStyle = getElementColor(ELEMENTOS[sign]);
                    ctx.font = 'bold 32px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(signSymbol, x, y);
                }

                // Dibujar casas (l√≠neas radiales y etiquetas)
                if (data.casas) {
                    for (let i = 1; i <= 12; i++) {
                        const casa = data.casas[i.toString()];
                        if (casa) {
                            const grado = casa.grado;
                            const signo = casa.signo;
                            const signoSimbolo = SIGN_SYMBOLS[signo] || '';
                            const angle = ((grado - 90) * Math.PI) / 180;
                            // L√≠nea radial de casa
                            ctx.strokeStyle = '#ff9800';
                            ctx.lineWidth = 2.5;
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.lineTo(
                                centerX + innerRadius * Math.cos(angle),
                                centerY + innerRadius * Math.sin(angle)
                            );
                            ctx.stroke();
                            // Etiqueta de casa y signo
                            const labelX =
                                centerX + houseLabelRadius * Math.cos(angle);
                            const labelY =
                                centerY + houseLabelRadius * Math.sin(angle);
                            ctx.fillStyle = '#ff9800';
                            ctx.font = 'bold 16px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(
                                i.toString() + ' ' + signoSimbolo,
                                labelX,
                                labelY
                            );
                        }
                    }
                }

                // Dibujar aspectos planetarios (l√≠neas de colores entre planetas)
                if (data.aspectos && data.planetas) {
                    const planetPos = {};
                    Object.entries(data.planetas).forEach(([planeta, info]) => {
                        const angle = ((info.grado - 90) * Math.PI) / 180;
                        planetPos[planeta] = {
                            x: centerX + planetRadius * Math.cos(angle),
                            y: centerY + planetRadius * Math.sin(angle),
                        };
                    });
                    data.aspectos.forEach((asp) => {
                        const p1 = planetPos[asp.planeta1];
                        const p2 = planetPos[asp.planeta2];
                        if (p1 && p2) {
                            // Color seg√∫n el aspecto
                            let color = '#2196f3'; // azul por defecto
                            if (
                                asp.aspecto
                                    .toLowerCase()
                                    .includes('cuadratura') ||
                                asp.aspecto.toLowerCase().includes('oposici√≥n')
                            )
                                color = '#e53935'; // rojo
                            if (asp.aspecto.toLowerCase().includes('tr√≠gono'))
                                color = '#43a047'; // verde
                            if (asp.aspecto.toLowerCase().includes('sextil'))
                                color = '#ffb300'; // amarillo
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 1.5;
                            ctx.beginPath();
                            ctx.moveTo(p1.x, p1.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    });
                }

                // Dibujar planetas (s√≠mbolos grandes y claros)
                if (data.planetas) {
                    Object.entries(data.planetas).forEach(([planeta, info]) => {
                        const grado = info.grado;
                        const angle = ((grado - 90) * Math.PI) / 180;
                        const x = centerX + planetRadius * Math.cos(angle);
                        const y = centerY + planetRadius * Math.sin(angle);
                        ctx.fillStyle = getElementColor(ELEMENTOS[info.signo]);
                        ctx.beginPath();
                        ctx.arc(x, y, 20, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 22px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(PLANET_SYMBOLS[planeta], x, y);
                    });
                }
            }

            function getElementColor(elemento) {
                const colors = {
                    fire: '#ff4757',
                    earth: '#2ed573',
                    air: '#3742fa',
                    water: '#5352ed',
                    fuego: '#ff4757',
                    tierra: '#2ed573',
                    aire: '#3742fa',
                    agua: '#5352ed',
                };
                return colors[elemento] || '#666';
            }

            function getElementClass(elemento) {
                const classes = {
                    fire: 'fire',
                    earth: 'earth',
                    air: 'air',
                    water: 'water',
                    fuego: 'fire',
                    tierra: 'earth',
                    aire: 'air',
                    agua: 'water',
                };
                return classes[elemento] || 'fire';
            }

            function displayPlanetInfo(data) {
                const container = document.getElementById('planetInfo');
                container.innerHTML = '';

                if (data.planetas) {
                    Object.entries(data.planetas).forEach(([planeta, info]) => {
                        const card = document.createElement('div');
                        card.className = 'planet-card';
                        card.innerHTML = `
                            <h3>${PLANET_NAMES[planeta]} ${
                            PLANET_SYMBOLS[planeta]
                        }</h3>
                            <p><strong>Signo:</strong> ${info.signo}</p>
                            <p><strong>Grado:</strong> ${info.grado.toFixed(
                                2
                            )}¬∞</p>
                        `;
                        container.appendChild(card);
                    });
                }

                // Informaci√≥n adicional del Sol, Luna y Ascendente
                if (data.sol_info || data.luna_info || data.ascendente_info) {
                    const additionalInfo = document.createElement('div');
                    additionalInfo.className = 'planet-card';
                    additionalInfo.style.gridColumn = 'span 2';

                    let infoHtml = '<h3>Informaci√≥n Adicional</h3>';

                    if (data.sol_info) {
                        infoHtml += `
                            <p><strong>Sol:</strong> ${data.planetas.sol.signo} - 
                            Elemento: ${data.sol_info.elemento}, Cualidad: ${data.sol_info.cualidad}</p>
                        `;
                    }

                    if (data.luna_info) {
                        infoHtml += `
                            <p><strong>Luna:</strong> ${data.planetas.luna.signo} - 
                            Elemento: ${data.luna_info.elemento}, Cualidad: ${data.luna_info.cualidad}</p>
                        `;
                    }

                    if (data.ascendente_info) {
                        infoHtml += `
                            <p><strong>Ascendente:</strong> ${data.ascendente} - 
                            Elemento: ${data.ascendente_info.elemento}, Cualidad: ${data.ascendente_info.cualidad}</p>
                        `;
                    }

                    additionalInfo.innerHTML = infoHtml;
                    container.appendChild(additionalInfo);
                }
            }

            function displayPlanetPositions(data) {
                const container = document.getElementById('planetPositions');
                if (!data.planetas) return;
                let html = `<table class="astro-table"><thead><tr><th>Planeta</th><th>S√≠mbolo</th><th>Signo</th><th>Grado</th><th>Casa</th></tr></thead><tbody>`;
                Object.entries(data.planetas).forEach(([planeta, info]) => {
                    // Buscar en qu√© casa est√° el planeta
                    let casaNum = '';
                    if (data.casas) {
                        for (let i = 1; i <= 12; i++) {
                            const c1 = data.casas[i.toString()].grado;
                            const c2 =
                                data.casas[i === 12 ? '1' : (i + 1).toString()]
                                    .grado;
                            let g = info.grado;
                            // Ajuste para casas que cruzan 0¬∞ Aries
                            if (c2 < c1) {
                                if (g >= c1 || g < c2) casaNum = i;
                            } else {
                                if (g >= c1 && g < c2) casaNum = i;
                            }
                        }
                    }
                    html += `<tr><td>${PLANET_NAMES[planeta]}</td><td>${
                        PLANET_SYMBOLS[planeta]
                    }</td><td>${info.signo}</td><td>${info.grado.toFixed(
                        2
                    )}¬∞</td><td>${casaNum}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function displayHouseCusps(data) {
                const container = document.getElementById('houseCusps');
                if (!data.casas) return;
                let html = `<table class="astro-table"><thead><tr><th>Casa</th><th>Signo</th><th>Grado</th></tr></thead><tbody>`;
                for (let i = 1; i <= 12; i++) {
                    const casa = data.casas[i.toString()];
                    html += `<tr><td>${i}</td><td>${
                        casa.signo
                    }</td><td>${casa.grado.toFixed(2)}¬∞</td></tr>`;
                }
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function displayAspectsTable(data) {
                const container = document.getElementById('aspectsTable');
                if (!data.aspectos) return;
                let html = `<table class="astro-table"><thead><tr><th>Planeta 1</th><th>Aspecto</th><th>Planeta 2</th><th>Orbe</th></tr></thead><tbody>`;
                data.aspectos.forEach((asp) => {
                    html += `<tr><td>${PLANET_NAMES[asp.planeta1]} ${
                        PLANET_SYMBOLS[asp.planeta1]
                    }</td><td>${asp.aspecto}</td><td>${
                        PLANET_NAMES[asp.planeta2]
                    } ${PLANET_SYMBOLS[asp.planeta2]}</td><td>${
                        asp.orbe
                    }¬∞</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function displayAspects(aspects) {
                const container = document.getElementById('aspectsList');
                container.innerHTML = '';

                if (aspects.length === 0) {
                    container.innerHTML =
                        '<p>No se encontraron aspectos significativos.</p>';
                    return;
                }

                const aspectsHtml = aspects
                    .map(
                        (aspect) => `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                        <strong>${PLANET_NAMES[aspect.planeta1]} ${
                            PLANET_SYMBOLS[aspect.planeta1]
                        } 
                        ${aspect.aspecto} 
                        ${PLANET_NAMES[aspect.planeta2]} ${
                            PLANET_SYMBOLS[aspect.planeta2]
                        }</strong>
                        <br>
                        <small>Orbe: ${aspect.orbe}¬∞</small>
                    </div>
                `
                    )
                    .join('');

                container.innerHTML = aspectsHtml;
            }

            function displayBalanceElementos(balance) {
                const container = document.getElementById('balanceElementos');
                container.innerHTML = '';

                if (!balance) return;

                // Resumen general
                const summary = document.createElement('div');
                summary.className = 'balance-summary';
                summary.innerHTML = `
                    <h3>${balance.resumen}</h3>
                    <p><strong>Elemento dominante:</strong> ${balance.dominante}</p>
                    <p><strong>Balance general:</strong> ${balance.balance_general}</p>
                `;
                container.appendChild(summary);

                // Barras de elementos
                Object.entries(balance.elementos).forEach(
                    ([elemento, info]) => {
                        const elementBar = document.createElement('div');
                        elementBar.className = 'element-bar';
                        const elementClass = getElementClass(
                            elemento.toLowerCase()
                        );
                        elementBar.innerHTML = `
                        <div class="element-name">${elemento}</div>
                        <div class="element-progress">
                            <div class="element-fill ${elementClass}" style="width: ${info.porcentaje}%">
                                ${info.cantidad}
                            </div>
                        </div>
                        <div class="element-stats">${info.porcentaje}%</div>
                    `;
                        container.appendChild(elementBar);
                    }
                );
            }
        </script>
    </body>
</html>
